name: Demo Build & Upload

on:
  push:
    branches: [ main, develop ]

env:
  NEXUS_URL: http://127.0.0.1:8081
  NEXUS_REPOSITORY_URL: http://127.0.0.1:8081/repository/JuiceShopMavenDemo
  NEXUS_USERNAME: admin
  NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
  NEXUS_GROUP_ID: com.example.vulnerable
  NEXUS_ARTIFACT_ID: vulnerable-app
  APP_NAME: vulnerable-app
  ARTIFACT_VERSION: ${{ github.run_number }}

jobs:
  build:
    # For local Nexus uploads, using: self-hosted runner
    # Setup: See .github/SELF_HOSTED_RUNNER_SETUP.md
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: pdo, pdo_sqlite, gd

      - name: Create ZIP Artifact
        run: |
          $zipPath = "${{ github.workspace }}\${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip"
          $excludePatterns = @('\.git', '\.github', '\.gitignore', 'node_modules', 'vendor', 'database.db', '*.zip')
          
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          
          $sourceDir = "${{ github.workspace }}"
          $zip = [System.IO.Compression.ZipFile]::Open($zipPath, 'Create')
          
          Get-ChildItem -Path $sourceDir -Recurse -File | Where-Object {
            $file = $_
            -not ($excludePatterns | Where-Object { $file.FullName -like "*$_*" })
          } | ForEach-Object {
            $entryPath = $_.FullName.Substring($sourceDir.Length).TrimStart('\')
            [System.IO.Compression.ZipFileExtensions]::CreateEntryFromFile($zip, $_.FullName, $entryPath) | Out-Null
          }
          
          $zip.Dispose()
          $zipSize = "{0:F2}" -f ((Get-Item $zipPath).Length / 1MB)
          Write-Host "✓ ZIP created: $zipSize MB"
        shell: pwsh

      - name: Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-build-${{ env.ARTIFACT_VERSION }}
          path: ${{ github.workspace }}\${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip
          retention-days: 30

      - name: Upload to Nexus
        run: |
          $zipFile = "${{ github.workspace }}\${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip"
          $groupPath = "${{ env.NEXUS_GROUP_ID }}".Replace(".", "/")
          $nexusUrl = "${{ env.NEXUS_REPOSITORY_URL }}/$groupPath/${{ env.NEXUS_ARTIFACT_ID }}/${{ env.ARTIFACT_VERSION }}/${{ env.NEXUS_ARTIFACT_ID }}-${{ env.ARTIFACT_VERSION }}.zip"
          
          Write-Host "Uploading to Nexus..."
          
          $base64Creds = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("${{ env.NEXUS_USERNAME }}:${{ env.NEXUS_PASSWORD }}"))
          $headers = @{
            "Authorization" = "Basic $base64Creds"
            "Content-Type" = "application/zip"
          }
          
          try {
            $response = Invoke-WebRequest -Uri $nexusUrl -Method PUT -InFile $zipFile -Headers $headers -UseBasicParsing
            Write-Host "✓ Uploaded to Nexus (Status: $($response.StatusCode))"
          } catch {
            Write-Host "⚠ Warning: Nexus upload failed - $($_.Exception.Message)"
            Write-Host "ℹ Note: If using windows-latest runner, Nexus is not accessible."
            Write-Host "ℹ Solution: Setup self-hosted runner on your VM (see .github/SELF_HOSTED_RUNNER_SETUP.md)"
          }
        shell: pwsh
        continue-on-error: true

      - name: Download from Nexus
        run: |
          Write-Host "Downloading latest artifact from Nexus..."
          
          $groupPath = "${{ env.NEXUS_GROUP_ID }}".Replace(".", "/")
          $nexusUrl = "${{ env.NEXUS_REPOSITORY_URL }}/$groupPath/${{ env.NEXUS_ARTIFACT_ID }}/${{ env.ARTIFACT_VERSION }}/${{ env.NEXUS_ARTIFACT_ID }}-${{ env.ARTIFACT_VERSION }}.zip"
          $downloadPath = "${{ github.workspace }}\downloaded-artifact.zip"
          
          $base64Creds = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("${{ env.NEXUS_USERNAME }}:${{ env.NEXUS_PASSWORD }}"))
          $headers = @{
            "Authorization" = "Basic $base64Creds"
          }
          
          try {
            Invoke-WebRequest -Uri $nexusUrl -OutFile $downloadPath -Headers $headers -UseBasicParsing
            $downloadSize = "{0:F2}" -f ((Get-Item $downloadPath).Length / 1MB)
            Write-Host "✓ Downloaded from Nexus: $downloadSize MB"
          } catch {
            Write-Host "✗ Failed to download from Nexus: $($_.Exception.Message)"
            exit 1
          }
        shell: pwsh

      - name: Deploy to IIS
        run: |
          Write-Host "Deploying to IIS..."
          
          $iisPath = "C:\inetpub\wwwroot\JuiceShop\${{ env.APP_NAME }}"
          $zipFile = "${{ github.workspace }}\downloaded-artifact.zip"
          
          # Create or clean deployment directory
          if (Test-Path $iisPath) {
            Write-Host "Cleaning existing deployment directory..."
            Remove-Item -Path $iisPath\* -Recurse -Force
          } else {
            Write-Host "Creating deployment directory..."
            New-Item -Path $iisPath -ItemType Directory -Force | Out-Null
          }
          
          # Extract ZIP to IIS
          Write-Host "Extracting application files..."
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile, $iisPath)
          
          $fileCount = (Get-ChildItem -Path $iisPath -Recurse -File).Count
          Write-Host "✓ Deployed $fileCount files to IIS"
          Write-Host "✓ Location: $iisPath"
        shell: pwsh

      - name: Restart IIS
        run: |
          Write-Host "Restarting IIS Application Pool..."
          
          try {
            # Restart the application pool (usually DefaultAppPool or specific pool)
            Import-Module WebAdministration
            
            # Find the app pool for this application
            $appPoolName = "DefaultAppPool"
            
            if (Get-WebAppPoolState -Name $appPoolName) {
              Restart-WebAppPool -Name $appPoolName
              Write-Host "✓ IIS Application Pool '$appPoolName' restarted"
              Start-Sleep -Seconds 2
            }
            
            # Alternative: Reset IIS completely
            Write-Host "Resetting IIS..."
            iisreset /restart /noforce
            Write-Host "✓ IIS restarted successfully"
            
          } catch {
            Write-Host "⚠ Warning: IIS restart encountered an issue - $($_.Exception.Message)"
          }
        shell: pwsh
        continue-on-error: true

      - name: Verify Deployment
        run: |
          Write-Host "Verifying deployment..."
          
          $appUrl = "http://localhost/vulnerable-app/"
          $iisPath = "C:\inetpub\wwwroot\JuiceShop\${{ env.APP_NAME }}"
          
          # Check files exist
          if (Test-Path "$iisPath\index.php") {
            Write-Host "✓ Application files deployed"
          } else {
            Write-Host "✗ index.php not found"
          }
          
          # Try to access application
          try {
            Start-Sleep -Seconds 2
            $response = Invoke-WebRequest -Uri $appUrl -UseBasicParsing -TimeoutSec 5
            if ($response.StatusCode -eq 200) {
              Write-Host "✓ Application is accessible at $appUrl"
            }
          } catch {
            Write-Host "⚠ Application may not be accessible yet: $($_.Exception.Message)"
            Write-Host "ℹ Check manually at: $appUrl"
          }
        shell: pwsh
        continue-on-error: true

      - name: Deployment Summary
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "✓ Deployment Completed" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Build #: ${{ github.run_number }}"
          Write-Host "Artifact: ${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip"
          Write-Host "Deployed to: C:\inetpub\wwwroot\JuiceShop\${{ env.APP_NAME }}"
          Write-Host "Application URL: http://localhost/vulnerable-app/"
          Write-Host "Nexus URL: ${{ env.NEXUS_REPOSITORY_URL }}"
          Write-Host ""
          Write-Host "Next Steps:"
          Write-Host "1. Access app at http://localhost/vulnerable-app/"
          Write-Host "2. View artifact in Nexus at http://127.0.0.1:8081/"
          Write-Host ""
        shell: pwsh
