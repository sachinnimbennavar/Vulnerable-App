name: Demo Build & Upload

on:
  push:
    branches: [ main, develop ]

env:
  NEXUS_URL: http://127.0.0.1:8081
  NEXUS_REPOSITORY_URL: http://127.0.0.1:8081/repository/JuiceShopMavenDemo
  NEXUS_USERNAME: admin
  NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
  NEXUS_GROUP_ID: com.example.vulnerable
  NEXUS_ARTIFACT_ID: vulnerable-app
  APP_NAME: vulnerable-app
  ARTIFACT_VERSION: ${{ github.run_number }}

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: pdo, pdo_sqlite, gd

      - name: Create ZIP Artifact
        run: |
          $zipPath = "${{ github.workspace }}\${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip"
          $excludePatterns = @('\.git', '\.github', '\.gitignore', 'node_modules', 'vendor', 'database.db', '*.zip')
          
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          
          $sourceDir = "${{ github.workspace }}"
          $zip = [System.IO.Compression.ZipFile]::Open($zipPath, 'Create')
          
          Get-ChildItem -Path $sourceDir -Recurse -File | Where-Object {
            $file = $_
            -not ($excludePatterns | Where-Object { $file.FullName -like "*$_*" })
          } | ForEach-Object {
            $entryPath = $_.FullName.Substring($sourceDir.Length).TrimStart('\')
            [System.IO.Compression.ZipFileExtensions]::CreateEntryFromFile($zip, $_.FullName, $entryPath) | Out-Null
          }
          
          $zip.Dispose()
          $zipSize = "{0:F2}" -f ((Get-Item $zipPath).Length / 1MB)
          Write-Host "✓ ZIP created: $zipSize MB"
        shell: pwsh

      - name: Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-build-${{ env.ARTIFACT_VERSION }}
          path: ${{ github.workspace }}\${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip
          retention-days: 30

      - name: Upload to Nexus
        run: |
          $zipFile = "${{ github.workspace }}\${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip"
          $groupPath = "${{ env.NEXUS_GROUP_ID }}".Replace(".", "/")
          $nexusUrl = "${{ env.NEXUS_REPOSITORY_URL }}/$groupPath/${{ env.NEXUS_ARTIFACT_ID }}/${{ env.ARTIFACT_VERSION }}/${{ env.NEXUS_ARTIFACT_ID }}-${{ env.ARTIFACT_VERSION }}.zip"
          
          Write-Host "Uploading to Nexus..."
          
          $base64Creds = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("${{ env.NEXUS_USERNAME }}:${{ env.NEXUS_PASSWORD }}"))
          $headers = @{
            "Authorization" = "Basic $base64Creds"
            "Content-Type" = "application/zip"
          }
          
          try {
            $response = Invoke-WebRequest -Uri $nexusUrl -Method PUT -InFile $zipFile -Headers $headers -UseBasicParsing
            Write-Host "✓ Uploaded to Nexus (Status: $($response.StatusCode))"
          } catch {
            Write-Host "⚠ Warning: Nexus upload failed - $($_.Exception.Message)"
          }
        shell: pwsh
        continue-on-error: true

      - name: Build Summary
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "✓ Build Completed" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Build #: ${{ github.run_number }}"
          Write-Host "Artifact: ${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}.zip"
          Write-Host "GitHub: Actions → Artifacts"
          Write-Host "Nexus: ${{ env.NEXUS_REPOSITORY_URL }}"
          Write-Host ""
        shell: pwsh
